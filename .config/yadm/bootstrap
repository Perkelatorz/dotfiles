#!/bin/bash
set -euo pipefail

# YADM Bootstrap Script
# Automates Arch Linux package installation and system setup (Arch Linux only).
# Requires: bash 4+, GNU find. Run after: yadm clone <repo> && yadm bootstrap
# Options: --core-only  skip interactive extra-package selection and Hyprland plugin prompt

# Configuration
PKG_DIR="$HOME/.config/yadm/packages"
SECRETS_FILE="$HOME/.config/nvim/secrets.lua"
MATUGEN_THEMES_DIR="$HOME/.config/matugen-themes"
SCRIPTS_DIR="$HOME/.config/scripts"
CORE_ONLY=false
tmp_pkg_file=""
tmp_aur_file=""

# Clean up temp files on exit (used in Phase 3)
cleanup_temp_files() {
    [[ -n "$tmp_pkg_file" && -f "$tmp_pkg_file" ]] && rm -f "$tmp_pkg_file"
    [[ -n "$tmp_aur_file" && -f "$tmp_aur_file" ]] && rm -f "$tmp_aur_file"
}
trap cleanup_temp_files EXIT

# Track installation stats
core_pacman_installed=0
core_pacman_skipped=0
core_aur_installed=0
core_aur_skipped=0
extra_pacman_installed=0
extra_pacman_skipped=0
extra_aur_installed=0
extra_aur_skipped=0

# --- Utility Functions ---

ensure_base_devel() {
    if ! pacman -Q base-devel &>/dev/null; then
        echo "üîß Installing base-devel (required for AUR builds)..."
        sudo pacman -S --needed --noconfirm base-devel
    fi
}

ensure_paru() {
    if ! command -v paru &>/dev/null; then
        ensure_base_devel
        echo "üîß Installing 'paru' AUR helper..."
        tmpdir="$(mktemp -d)"
        trap "rm -rf '$tmpdir'" EXIT
        git clone https://aur.archlinux.org/paru.git "$tmpdir/paru"
        (cd "$tmpdir/paru" && makepkg -si --noconfirm)
        rm -rf "$tmpdir"
        trap - EXIT
        trap cleanup_temp_files EXIT
    fi
}

read_pkg_file() {
    # Read non-empty, non-comment lines from a file into stdout
    local file="$1"
    if [[ ! -f "$file" ]]; then
        echo "‚ö†Ô∏è  Warning: Package file '$file' not found" >&2
        return 1
    fi
    grep -v '^[[:space:]]*#' "$file" | grep -v '^[[:space:]]*$' || true
}

dedupe_array() {
    # Usage: dedupe_array "${arr[@]}"
    awk '!seen[$0]++'
}

filter_installed_packages_bulk() {
    # Check multiple packages at once (much faster than one-by-one)
    # Uses bulk queries: pacman -Q and paru -Q can check multiple packages at once
    # args: package manager type, package array
    local pkgmgr="$1"
    shift
    local -a pkgs=("$@")
    
    if [ ${#pkgs[@]} -eq 0 ]; then
        return 0
    fi
    
    # Filter out empty packages
    local -a valid_pkgs=()
    for pkg in "${pkgs[@]}"; do
        [[ -n "$pkg" ]] && valid_pkgs+=("$pkg")
    done
    
    if [ ${#valid_pkgs[@]} -eq 0 ]; then
        return 0
    fi
    
    # Query all packages at once - only installed ones will be in output
    local installed_output
    if [[ "$pkgmgr" == "pacman" ]]; then
        installed_output=$(pacman -Q "${valid_pkgs[@]}" 2>/dev/null | awk '{print $1}' || true)
    else
        installed_output=$(paru -Q "${valid_pkgs[@]}" 2>/dev/null | awk '{print $1}' || true)
    fi
    
    # Check each package - if it's in the installed output, it's installed
    for pkg in "${valid_pkgs[@]}"; do
        if echo "$installed_output" | grep -Fxq "$pkg" 2>/dev/null; then
            echo "installed $pkg"
        else
            echo "missing $pkg"
        fi
    done
}

install_packages_batch() {
    # Install packages in a single bulk operation (much faster than one-by-one)
    # args: package manager type, package list
    local pkgmgr="$1"
    shift
    local -a pkgs=("$@")
    
    if [ ${#pkgs[@]} -eq 0 ]; then
        return 0
    fi
    
    local pkgmgr_name
    if [[ "$pkgmgr" == "pacman" ]]; then
        pkgmgr_name="pacman"
        echo "   ‚Üí Installing ${#pkgs[@]} pacman packages in bulk..."
        # --needed skips already installed packages, --noconfirm is non-interactive
        # This installs all packages in a single transaction (fastest method)
        if sudo pacman -S --needed --noconfirm "${pkgs[@]}"; then
            echo "   ‚úì Successfully installed ${#pkgs[@]} packages"
            return 0
        else
            echo "   ‚ö†Ô∏è  Bulk pacman install had issues. Attempting per-package fallback..."
            local failed=0
            for p in "${pkgs[@]}"; do
                if sudo pacman -S --needed --noconfirm "$p" >/dev/null 2>&1; then
                    : # Success
                else
                    echo "   ‚ö†Ô∏è  Failed to install $p"
                    failed=$((failed + 1))
                fi
            done
            if [ $failed -eq 0 ]; then
                echo "   ‚úì All packages installed successfully via fallback"
            else
                echo "   ‚ö†Ô∏è  $failed package(s) failed to install"
            fi
            return 0
        fi
    else
        pkgmgr_name="AUR"
        echo "   ‚Üí Installing ${#pkgs[@]} AUR packages in bulk..."
        # paru handles bulk AUR installations efficiently
        set +e
        if paru -S --needed --noconfirm "${pkgs[@]}"; then
            set -e
            echo "   ‚úì Successfully installed ${#pkgs[@]} packages"
            return 0
        else
            set -e
            echo "   ‚ö†Ô∏è  Bulk AUR install had issues. Attempting per-package fallback..."
            local failed=0
            for p in "${pkgs[@]}"; do
                set +e
                if paru -S --needed --noconfirm "$p" >/dev/null 2>&1; then
                    : # Success
                else
                    echo "   ‚ö†Ô∏è  Failed to install $p"
                    failed=$((failed + 1))
                fi
                set -e
            done
            if [ $failed -eq 0 ]; then
                echo "   ‚úì All packages installed successfully via fallback"
            else
                echo "   ‚ö†Ô∏è  $failed package(s) failed to install"
            fi
            return 0
        fi
    fi
}

process_packages() {
    # Unified function to process packages (pacman or AUR)
    # args: pkgmgr_type, package_file, installed_counter_var, skipped_counter_var
    local pkgmgr="$1"
    local pkg_file="$2"
    local installed_var="$3"
    local skipped_var="$4"
    
    if [[ ! -f "$pkg_file" ]]; then
        echo "‚ö†Ô∏è  $pkg_file not found. Skipping."
        return 0
    fi
    
    local pkgmgr_name
    local pkgmgr_icon
    if [[ "$pkgmgr" == "pacman" ]]; then
        pkgmgr_name="pacman"
        pkgmgr_icon="üì¶"
    else
        pkgmgr_name="AUR"
        pkgmgr_icon="üîß"
    fi
    
    mapfile -t packages < <(read_pkg_file "$pkg_file" | dedupe_array)
    
    if [ ${#packages[@]} -eq 0 ]; then
        return 0
    fi
    
    echo "$pkgmgr_icon Processing ${#packages[@]} $pkgmgr_name packages..."
    
    if [[ "$pkgmgr" == "aur" ]]; then
        ensure_paru
    fi
    
    # Split into installed vs missing (using bulk checking)
    local installed_list=()
    local missing_list=()
    while read -r status pkg; do
        if [[ "$status" == "installed" ]]; then
            installed_list+=("$pkg")
        else
            missing_list+=("$pkg")
        fi
    done < <(
        filter_installed_packages_bulk "$pkgmgr" "${packages[@]}"
    )
    
    for p in "${installed_list[@]}"; do
        echo "   ‚úì $p (already installed)"
    done
    
    # Update counters
    eval "$skipped_var=\$((\$$skipped_var + \${#installed_list[@]}))"
    
    if [ ${#missing_list[@]} -gt 0 ]; then
        install_packages_batch "$pkgmgr" "${missing_list[@]}"
        eval "$installed_var=\$((\$$installed_var + \${#missing_list[@]}))"
    fi
}

# --- Setup Functions ---

setup_matugen_themes() {
    if [[ -d "$MATUGEN_THEMES_DIR/.git" ]]; then
        echo "   ‚úì matugen-themes already cloned"
        return 0
    fi
    if [[ -d "$MATUGEN_THEMES_DIR" ]]; then
        echo "   ‚ö†Ô∏è  $MATUGEN_THEMES_DIR exists but is not a git repo; skipping clone."
        echo "      Remove it or run: git clone https://github.com/InioX/matugen-themes.git $MATUGEN_THEMES_DIR"
        return 0
    fi
    echo "üé® Cloning matugen-themes (for Quickshell/Hyprland theming)..."
    mkdir -p "$(dirname "$MATUGEN_THEMES_DIR")"
    if git clone --depth 1 https://github.com/InioX/matugen-themes.git "$MATUGEN_THEMES_DIR"; then
        echo "   ‚úì Cloned to $MATUGEN_THEMES_DIR"
    else
        echo "   ‚ö†Ô∏è  Failed to clone matugen-themes (select-wallpaper.sh will need it)"
    fi
}

setup_scripts_executable() {
    local count=0
    if [[ -d "$SCRIPTS_DIR" ]]; then
        for f in "$SCRIPTS_DIR"/*.sh; do
            if [[ -f "$f" ]]; then
                chmod +x "$f"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo "   ‚úì $count script(s) in $SCRIPTS_DIR made executable"
        else
            echo "   (no .sh scripts in $SCRIPTS_DIR)"
        fi
    else
        echo "   (scripts dir not found: $SCRIPTS_DIR)"
    fi
}

setup_neovim_secrets() {
    echo "üîê Setting up Neovim API keys..."
    
    if [[ ! -d "$(dirname "$SECRETS_FILE")" ]]; then
        mkdir -p "$(dirname "$SECRETS_FILE")"
    fi
    
    if [ -f "$SECRETS_FILE" ]; then
        echo "   ‚úì secrets.lua already exists, skipping..."
    else
        echo "   Creating secrets.lua template..."
        cat > "$SECRETS_FILE" << 'EOF'
return {
  ANTHROPIC_API_KEY = "your-anthropic-key-here",
  OPENAI_API_KEY = "your-openai-key-here",
}
EOF
        echo "   ‚úì Created $SECRETS_FILE"
        echo "   ‚ö†Ô∏è  Please edit this file and add your actual API keys!"
    fi
}

setup_hyprland_plugins() {
    # Default plugins list - can be extended
    local -a plugins=(
        "https://github.com/Duckonaut/split-monitor-workspaces"
        "https://github.com/cpiber/hyprscroller"
    )
    
    # Check if hyprpm is available
    if ! command -v hyprpm &> /dev/null; then
        echo "‚ö†Ô∏è  hyprpm command not found. Skipping Hyprland plugin setup."
        echo "   (Please ensure Hyprland is properly installed)"
        return 1
    fi
    
    echo "ü™ü Setting up Hyprland plugins..."
    
    # Update Hyprland repos
    echo "   ‚Üí Updating Hyprland repos..."
    if ! hyprpm update; then
        echo "   ‚ö†Ô∏è  Failed to update Hyprland repos"
        return 1
    fi
    echo "   ‚úì Hyprland repos updated"
    
    # Add and enable each plugin
    for plugin_url in "${plugins[@]}"; do
        local plugin_name=$(basename "$plugin_url" .git)
        
        echo "   ‚Üí Adding $plugin_name plugin..."
        if ! hyprpm add "$plugin_url"; then
            echo "   ‚ö†Ô∏è  Failed to add $plugin_name plugin repository"
            continue
        fi
        echo "   ‚úì Plugin repository added"
        
        echo "   ‚Üí Enabling $plugin_name plugin..."
        if ! hyprpm enable "$plugin_name"; then
            echo "   ‚ö†Ô∏è  Failed to enable $plugin_name plugin"
            continue
        fi
        echo "   ‚úì Plugin enabled"
    done
    
    # Reload the plugins
    echo "   ‚Üí Reloading plugins..."
    if ! hyprpm reload; then
        echo "   ‚ö†Ô∏è  Failed to reload plugins"
        return 1
    fi
    echo "   ‚úì Plugins reloaded"
    
    echo "‚úÖ Hyprland plugin setup complete!"
}

# --- Parse options ---
for arg in "${@:-}"; do
    case "$arg" in
        --core-only) CORE_ONLY=true ;;
    esac
done

# --- PHASE 1: Install Core Dependencies (Non-Interactive) ---

echo "üöÄ Starting Arch Linux Setup..."
echo

# Pre-flight: sudo and package list dir
if ! sudo -n true 2>/dev/null; then
    echo "‚ö†Ô∏è  This script needs sudo. You may be prompted for your password."
fi
if [[ ! -d "$PKG_DIR" ]]; then
    echo "‚ùå Package directory not found: $PKG_DIR"
    echo "   Ensure you have run 'yadm clone <repo>' so dotfiles (including .config/yadm/packages) are present."
    exit 1
fi
if [[ ! -f "$PKG_DIR/core.pkgs" ]]; then
    echo "‚ùå Core package list not found: $PKG_DIR/core.pkgs"
    exit 1
fi
# core.aur is optional; if missing, AUR step is skipped

# Setup Neovim secrets (creates template; safe if nvim not installed yet)
setup_neovim_secrets
echo

echo "üîÑ Installing core system tools..."

# Update package database
sudo pacman -Sy --noconfirm

# Core pacman packages
process_packages "pacman" "$PKG_DIR/core.pkgs" "core_pacman_installed" "core_pacman_skipped"

# Core AUR packages (ensure_paru will install base-devel if needed for paru build)
process_packages "aur" "$PKG_DIR/core.aur" "core_aur_installed" "core_aur_skipped"

# Post-install: matugen-themes for select-wallpaper.sh / Quickshell theme
setup_matugen_themes

# Ensure all dotfile scripts are executable (yadm may not preserve +x)
setup_scripts_executable

echo "‚úÖ Core tools done."
echo

# --- Hyprland plugin setup (optional, runs after core so hyprpm may be available) ---
if [[ "$CORE_ONLY" != "true" ]] && [[ -t 0 ]] && (command -v hyprpm &>/dev/null || command -v hyprland &>/dev/null); then
    read -p "Do you want to set up Hyprland plugins? (y/N): " choice
    choice=${choice,,}
    if [[ "$choice" == "y" || "$choice" == "yes" ]]; then
        setup_hyprland_plugins
    else
        echo "‚è≠Ô∏è  Skipping Hyprland plugin setup."
    fi
elif [[ "$CORE_ONLY" == "true" ]]; then
    echo "‚è≠Ô∏è  (--core-only: skipping Hyprland plugin prompt)"
fi
echo

# --- PHASE 2: Interactive Package Selection ---

final_packages=()
final_aur=()

# Find all .pkgs and .aur files EXCEPT core.*, then let user pick (or skip if --core-only / non-interactive)
if [[ "$CORE_ONLY" == "true" ]]; then
    selections=""
    echo "‚è≠Ô∏è  (--core-only: skipping extra package selection)"
elif [[ -t 0 ]] && command -v fzf >/dev/null 2>&1; then
    selections=$(find "$PKG_DIR" \( -name "*.pkgs" -o -name "*.aur" \) \
        ! -name 'core.pkgs' ! -name 'core.aur' \
        -printf "%f\n" | \
        fzf -m --prompt="Select package lists (TAB to mark, ENTER to confirm) > " \
            --header="Core packages already installed. Choose the rest." \
            --preview="echo 'Contents of {}:'; echo '---'; cat \"$PKG_DIR/{}\"" || true)
else
    if [[ ! -t 0 ]]; then
        echo "‚ö†Ô∏è  Not a TTY; skipping extra package selection (use --core-only to suppress, or run interactively)."
        selections=""
    else
        echo "‚ö†Ô∏è  fzf not found. Selecting all non-core lists."
        selections=$(find "$PKG_DIR" \( -name "*.pkgs" -o -name "*.aur" \) ! -name 'core.pkgs' ! -name 'core.aur' -printf "%f\n" 2>/dev/null || true)
    fi
fi

if [[ -z "${selections:-}" ]]; then
    echo "No extra packages selected. Setup complete!"
    echo
    echo "üìã Installation Summary:"
    echo "   ‚Ä¢ Core pacman: $core_pacman_installed installed, $core_pacman_skipped skipped"
    echo "   ‚Ä¢ Core AUR: $core_aur_installed installed, $core_aur_skipped skipped"
    echo "   ‚Ä¢ Extra pacman: 0 installed, 0 skipped"
    echo "   ‚Ä¢ Extra AUR: 0 installed, 0 skipped"
    exit 0
fi

echo "‚úÖ Selections confirmed. Building remaining package lists..."

while IFS= read -r selection; do
    file="$PKG_DIR/$selection"
    case "$selection" in
        *.pkgs)
            echo " -> Loading pacman packages from $file"
            mapfile -t temp_packages < <(read_pkg_file "$file")
            final_packages+=("${temp_packages[@]}")
            ;;
        *.aur)
            echo " -> Loading AUR packages from $file"
            mapfile -t temp_aur < <(read_pkg_file "$file")
            final_aur+=("${temp_aur[@]}")
            ;;
    esac
done <<< "$selections"

# Dedupe extras
mapfile -t final_packages < <(printf "%s\n" "${final_packages[@]}" | dedupe_array)
mapfile -t final_aur < <(printf "%s\n" "${final_aur[@]}" | dedupe_array)

# --- PHASE 3: Install extras (batched) ---

# Process extra pacman packages
if [ ${#final_packages[@]} -gt 0 ]; then
    tmp_pkg_file=$(mktemp)
    printf "%s\n" "${final_packages[@]}" > "$tmp_pkg_file"
    process_packages "pacman" "$tmp_pkg_file" "extra_pacman_installed" "extra_pacman_skipped"
    rm -f "$tmp_pkg_file"
    tmp_pkg_file=""
fi

# Process extra AUR packages
if [ ${#final_aur[@]} -gt 0 ]; then
    tmp_aur_file=$(mktemp)
    printf "%s\n" "${final_aur[@]}" > "$tmp_aur_file"
    process_packages "aur" "$tmp_aur_file" "extra_aur_installed" "extra_aur_skipped"
    rm -f "$tmp_aur_file"
    tmp_aur_file=""
fi

# --- SUMMARY ---

echo
echo "‚ú® Setup finished successfully!"
echo
echo "üìã Installation Summary:"
echo "   ‚Ä¢ Core pacman: $core_pacman_installed installed, $core_pacman_skipped skipped"
echo "   ‚Ä¢ Core AUR: $core_aur_installed installed, $core_aur_skipped skipped"
echo "   ‚Ä¢ Extra pacman: $extra_pacman_installed installed, $extra_pacman_skipped skipped"
echo "   ‚Ä¢ Extra AUR: $extra_aur_installed installed, $extra_aur_skipped skipped"
echo
total_installed=$((core_pacman_installed + core_aur_installed + extra_pacman_installed + extra_aur_installed))
total_skipped=$((core_pacman_skipped + core_aur_skipped + extra_pacman_skipped + extra_aur_skipped))
echo "üéØ Total: $total_installed installed, $total_skipped skipped"
echo
echo "‚ú® Bootstrap complete!"
